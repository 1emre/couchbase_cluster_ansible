- name: "CouchBase Installation"
  hosts: all
  become: True
  vars_files:
    - vars/main.yaml

  roles:
    - firewall
    - selinux

  tasks:
    - name: "Download & Install CouchBase Repository"
      yum:
        name: "{{ couchbase_latest_repo_url }}"
        state: present
        update_cache: no

    - name: "Install CouchBase Packages"
      yum:
        name: "couchbase-server-community"
        state: present
        update_cache: no

- name: "Initialize the cluster and add the nodes to the cluster"
  hosts: couchbase_main
  become: True
  vars_files:
    - vars/main.yaml

  tasks:
    - name: "Configure main node"
      shell: /opt/couchbase/bin/couchbase-cli cluster-init -c {{ couchbase_master_node.host }}:{{ couchbase_master_node.port }} --cluster-username={{ admin_user }} --cluster-password={{ admin_password }} --cluster-port={{ couchbase_master_node.port }} --cluster-ramsize={{ cluster_ram_quota }}

    - name: "Create shell script for configuring main node"
      action: template src=templates/couchbase-add-node.j2 dest=/tmp/addnodes.sh mode=750

    - name: "Launch config script"
      action: shell /tmp/addnodes.sh

    - name: "Rebalance the cluster"
      shell: /opt/couchbase/bin/couchbase-cli rebalance -c {{ couchbase_master_node.host }}:{{ couchbase_master_node.port }} -u {{ admin_user }} -p {{ admin_password }}
